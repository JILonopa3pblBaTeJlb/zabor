# ZABOR — бот-вороватор контента из Telegram-каналов

Бот копирует посты из указанных каналов в приватный канал с кнопкой «Класс!», а по нажатию публикует их в целевой канал.

## Требования

Python 3.13

```
telethon==1.29.1        # userbot для чтения каналов
aio gram==3.3.1          # бот-агент
Pillow==10.3.0          # обработка изображений
ImageHash==4.3.1        # phash хеширование медиа
```

## Архитектура

**Telethon (userbot)** — читает каналы, скачивает медиа, следит за обновлениями. Работает через `API_ID` и `API_HASH` пользователя.

**Aiogram (бот-агент)** — управляет командными интерфейсами, публикует контент в каналы, обрабатывает кнопку «Класс!». Работает через `BOT_TOKEN`.

### Файлы

* `config.json` — настройки API и ID каналов
* `db.json` — список каналов и их `last_id`
* `seen.json` — сохранённые хэши уже увиденных постов
* `admins.txt` — список админов
* `tmp/` — временные файлы медиа

## Жизненный цикл запуска

1. Читается `config.json` и подставляются параметры (API, токены, ID каналов).
2. Запускаются Telethon и Aiogram.
3. Загружаются файлы `db.json`, `seen.json`, `admins.txt`.
4. Асинхронно стартует:

   * `client.start()` — запуск userbot’а
   * `dp.start_polling(bot)` — запуск бота-агента
   * `poll_monitored_channels()` — постоянный опрос каналов

## Как работает опрос каналов

Функция `poll_monitored_channels`:

* Каждую минуту получает последние 5 сообщений из каждого канала (`get_messages(limit=5)`).
* Для каждого нового сообщения (`msg.id > last_id`) вызывает `process_message(msg)`.
* После обработки обновляет `last_id`.

## Обработка сообщений (`process_message`)

Извлекается чат, `chat_id`, `username`, `текст`.

Игнорируются:

* посты со стоп-словами
* слишком длинные тексты (>100 символов)
* посты с Telegram web preview
* галереи (`grouped_id`)

Формируется caption с ссылкой на источник:
`https://t.me/{username}/{msg.id}`

Создаётся inline-кнопка **Класс!** с `callback_data`:
`like_post:{msg.id}:{chat_id}`

Если есть YouTube-ссылки — публикуются как текстовые ссылки без файлов.

Если есть медиа:

* скачивается во временный файл
* определяется тип: фото / гиф / видео / документ
* публикуется в `ZABORISTOE` с кнопкой и подписью, и в `DOPAMINE` без подписи и кнопки
* файл удаляется

Если есть только текст — публикуется в `ZABORISTOE`.

Пауза между постами — `await asyncio.sleep(3)`.

## Обработка кнопки «Класс!»

При нажатии бот:

1. Разбирает `message_id` и `chat_id` из `callback_data`.
2. Получает оригинал поста через `get_messages`.
3. Скачивает медиа.
4. Отправляет его в канал `IPNTZ`.
5. Убирает кнопку у исходного поста.
6. Отвечает пользователю: `✓ Отправлено в IPNTZ`.

## Настройка

### 1. Получение API_ID и API_HASH

* Зайди на [my.telegram.org](https://my.telegram.org)
* Войди под номером userbot-аккаунта
* Перейди **API Development tools → Create new application**
* Скопируй `API_ID` и `API_HASH`

### 2. Создание бота-агента

* В Telegram открой [@BotFather](https://t.me/BotFather)
* `/newbot` → введи имя и username (например `zabornybot`)
* Получи `BOT_TOKEN`

### 3. Получение ID каналов

* Используй [@ChatIdInfoBot](https://t.me/ChatIdInfoBot)
* Перешли сообщение из канала → получишь ID `-100xxxxxxxxxx`

### 4. Настройка `config.json`

```json
{
  "API_ID": 123456,
  "API_HASH": "abcdef123456",
  "BOT_TOKEN": "123456789:ABC-DEF",
  "ZABORISTOE": -1001111111111,
  "DOPAMINE": -1002222222222,
  "IPNTZ": -1003333333333,
  "DB_FILE": "db.json",
  "SEEN_FILE": "seen.json",
  "ADMINS_FILE": "admins.txt"
}
```

## Чеклист перед запуском

* [ ] Все ID каналов корректны и начинаются с `-100`
* [ ] Создан каталог `tmp/`
* [ ] Установлены зависимости
* [ ] Заполнен `admins.txt`
* [ ] Проверено, что `db.json` и `seen.json` существуют (или пустые)

## Команды бота-агента

* `/list` — список текущих каналов
* `/remove @channel_or_id` — удалить канал
* `/stats` — статистика (количество каналов, размер `seen.json`)
* `/addword слово` - добавить стоп-слово (посты с такими словами в caption игнорятся)

Если админ шлёт в личку список `@channel` или `-100...`, бот добавит их в мониторинг (`db.json`, `last_id: 0`).

## Примечания

* Галереи игнорируются (часто реклама).
* Telegram link previews не репостятся.
* Caption не сохраняется специально — чтобы убрать мусорные тексты и маркетинговые подписи.
* Код содержит задел на проверку баянов по `phash` или хз, мож еще чего придумаем.
* Не нужно подписываться на все подряд.
* Для стабильной работы нужен мощный канал и хранилище при большом объёме постов.
